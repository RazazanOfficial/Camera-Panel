document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("form"),t=document.getElementById("User Name"),n=document.getElementById("password"),o=e.querySelector('button[type="submit"]'),r=e=>{o.disabled=e,e?(o.dataset.prevText=o.textContent,o.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Logging in...'):o.dataset.prevText&&(o.textContent=o.dataset.prevText,delete o.dataset.prevText)};e.addEventListener("submit",(async e=>{e.preventDefault();const o=(t.value||"").trim(),i=n.value||"";if(o&&i)try{r(!0),toast.info("Requesting random challenge...");const e=await apiPost(`${API_ENDPOINTS.login}?user=${encodeURIComponent(o)}`),t=("string"==typeof e?JSON.parse(e):e)?.random;if(t===undefined||null===t)throw new Error("Server did not return 'random'.");const n=function(e){if("function"==typeof window.md5)return window.md5(e);if(window.CryptoJS?.MD5)return window.CryptoJS.MD5(e).toString();if("function"==typeof window.hex_md5)return window.hex_md5(e);throw new Error("MD5 library not found. Please load md5.min.js before login.js.")}(`${o}:${t}:${i}`);toast.info("Verifying credentials...");const s=await apiPost(`${API_ENDPOINTS.loginToken}?credit=${encodeURIComponent(n)}`),d=("string"==typeof s?JSON.parse(s):s)?.token;if(!d)throw new Error("Server did not return 'token'.");window.Auth.setToken(d),toast.success("Logged in successfully. Redirecting..."),setTimeout((()=>{window.location.href="./viewControll.html"}),600)}catch(s){console.error(s),toast.error(`Login failed: ${s.message||"Unexpected error."}`)}finally{r(!1),n.value=""}else toast.warning("Please enter both username and password.")}))}));