const STREAM_URL=`${DEVICE_ORIGIN}/mjpeg`,img=document.getElementById("mjpegStream"),playPauseBtn=document.getElementById("playPauseBtn"),fullscreenBtn=document.getElementById("fullscreenBtn"),container=document.getElementById("videoContainer"),fallbackBox=document.getElementById("streamFallback"),btnOpenFixModal=document.getElementById("btnOpenFixModal"),fixModalEl=document.getElementById("streamFixModal");let fixBsModal=null;fixModalEl&&(fixBsModal=new bootstrap.Modal(fixModalEl,{backdrop:!0,keyboard:!0}));const btnEnableJpeg=document.getElementById("btnEnableJpeg"),btnDisableSub=document.getElementById("btnDisableSub"),btnFixClose=document.getElementById("btnFixClose");let isPlaying=!0,showedFallback=!1;function bustCacheUrl(e){const t=e.includes("?")?"&":"?";return`${e}${t}_t=${Date.now()}`}function showFallback(){if(!showedFallback){showedFallback=!0;try{pauseStream()}catch{}img&&img.classList.add("d-none"),fallbackBox&&fallbackBox.classList.remove("d-none")}}function hideFallback(){showedFallback=!1,fallbackBox&&fallbackBox.classList.add("d-none"),img&&img.classList.remove("d-none")}function playStream(){isPlaying||img&&(img.src=bustCacheUrl(STREAM_URL),isPlaying=!0,playPauseBtn&&(playPauseBtn.textContent="Pause"))}function pauseStream(){isPlaying&&img&&(img.src="",isPlaying=!1,playPauseBtn&&(playPauseBtn.textContent="Play"))}playPauseBtn?.addEventListener("click",(()=>{isPlaying?pauseStream():playStream()})),fullscreenBtn?.addEventListener("click",(()=>{document.fullscreenElement?document.exitFullscreen?.():container?.requestFullscreen?.()})),img?.addEventListener("error",(()=>{showFallback()})),img?.addEventListener("load",(()=>{hideFallback()})),window.addEventListener("load",(()=>{img&&(img.src=bustCacheUrl(STREAM_URL))}));const allGroups=[...new Set(Array.from(document.querySelectorAll(".adjustment-group")).map((e=>e.dataset.group)))];allGroups.forEach((e=>{const t=document.querySelectorAll(`.adjustment-group[data-group="${e}"] .rangeSlider`),a=document.querySelectorAll(`.adjustment-group[data-group="${e}"] .stepInput`),n=document.querySelectorAll(`.adjustment-group[data-group="${e}"] .increaseBtn`),l=document.querySelectorAll(`.adjustment-group[data-group="${e}"] .decreaseBtn`),o=e=>{e=Math.max(1,Math.min(4e3,parseInt(e))),t.forEach((t=>t.value=e)),s()},s=()=>{t.forEach((e=>{const t=(e.value-e.min)/(e.max-e.min)*100;e.style.setProperty("--val",`${t}%`)}))};t.forEach((e=>{e.addEventListener("input",(()=>{o(e.value)})),s()})),n.forEach((e=>{e.addEventListener("click",(()=>{const e=parseInt(t[0].value),n=parseInt(a[0].value)||1;o(e+n)}))})),l.forEach((e=>{e.addEventListener("click",(()=>{const e=parseInt(t[0].value),n=parseInt(a[0].value)||1;o(e-n)}))}))})),function(){if(!(fixModalEl&&btnOpenFixModal&&btnEnableJpeg&&btnDisableSub))return;function e(e){const t=API_ENDPOINTS.video,a=t.includes("?")?"&":"?";return`${t}${a}protocol=${encodeURIComponent(e)}`}function t(e){const t=API_ENDPOINTS.video,a=t.includes("?")?"&":"?";return`${t}${a}channel=${encodeURIComponent(e)}`}function a(e,t){e.classList.remove("btn-outline-secondary","btn-outline-danger","btn-success"),e.classList.add(t?"btn-success":"btn-outline-danger")}async function n(e,t,a){try{return await apiPost(e,t)}catch(n){try{return await apiPost(e,a)}catch(l){throw l}}}btnEnableJpeg.addEventListener("click",(async()=>{btnEnableJpeg.disabled=!0;try{toast?.info?.("Enabling JPEG protocol…"),await n(e("jpeg"),{enabled:"true"},{jpeg:{enabled:"true"}}),await apiPost(API_ENDPOINTS.appConfigApply,{}),a(btnEnableJpeg,!0),toast?.success?.("JPEG protocol enabled & applied")}catch(t){console.error("[viewController] enable JPEG failed:",t),a(btnEnableJpeg,!1),toast?.error?.("Enabling JPEG failed")}finally{btnEnableJpeg.disabled=!1}})),btnDisableSub.addEventListener("click",(async()=>{btnDisableSub.disabled=!0;try{toast?.info?.("Disabling Sub Stream (Channel 1) …"),await n(t(1),{enabled:"false"},{video1:{enabled:"false"}}),await apiPost(API_ENDPOINTS.appConfigApply,{}),a(btnDisableSub,!0),toast?.success?.("Sub Stream disabled & applied")}catch(e){console.error("[viewController] disable Sub Stream failed:",e),a(btnDisableSub,!1),toast?.error?.("Disabling Sub Stream failed")}finally{btnDisableSub.disabled=!1}})),btnOpenFixModal.addEventListener("click",(()=>{try{fixBsModal?.show()}catch{}})),fixModalEl.addEventListener("shown.bs.modal",(async function(){try{const n=await apiGet(e("jpeg"));a(btnEnableJpeg,!!n?.jpeg?.enabled);const l=await apiGet(t(1));a(btnDisableSub,!!!l?.video1?.enabled)}catch(n){console.error("[viewController] loadStates failed:",n),toast?.error?.("Failed to check current stream settings")}}));const l=()=>setTimeout((()=>window.location.reload()),50);fixModalEl.addEventListener("hidden.bs.modal",l),btnFixClose?.addEventListener("click",(()=>{try{fixBsModal?.hide()}catch{}l()}))}();