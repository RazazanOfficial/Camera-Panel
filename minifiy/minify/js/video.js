"use strict";document.addEventListener("DOMContentLoaded",(()=>{if(!document.querySelector('[data-tab-content="video"]'))return;const e=document.getElementById("streamType"),t=document.getElementById("videoEnabled"),n=document.getElementById("videoCodec"),o=document.getElementById("videoSize"),i=document.getElementById("videoFps"),r=document.getElementById("videoRcMode"),a=document.getElementById("videoBitrate"),d=document.getElementById("videoProfile"),c=document.getElementById("videoGopSize"),l=document.getElementById("videoCrop"),s=document.getElementById("videoCh0Extras"),u=document.getElementById("videoGopMode"),g=document.getElementById("videoSliceUnits"),m=document.getElementById("btnVideoSave"),v={0:["1920x1080","1280x960","1280x720","800x488","704x576"],1:["1280x960","1280x720","800x488","704x576","640x480"]},p={enabled:!0,codec:"h264",fps:25,bitrate:2048,rcMode:"cbr",profile:"main",gopSize:50,crop:"",gopMode:"normal",sliceUnits:0};function f(e){const t=API_ENDPOINTS.video,n=t.includes("?")?"&":"?";return`${t}${n}channel=${encodeURIComponent(e)}`}function b(e,t,n=(e=>e)){e.innerHTML=t.map((e=>`<option value="${e}">${n(e)}</option>`)).join("")}function y(e,t,n=!0){const o=String(t??"");Array.from(e.options).find((e=>e.value===o))?e.value=o:n&&e.options.length&&(e.selectedIndex=0)}function S(e){m.disabled=e,m.classList.toggle("disabled",e),m.style.opacity=e?.75:1}async function I(e){try{!function(e){s.style.display="0"===String(e)?"":"none"}(e),function(e){const t=v[String(e)]||[];b(o,t,(e=>e.replace("x","Ã—")));const n=Array.from({length:25},((e,t)=>String(t+1)));b(i,n,(e=>e))}(e);const m=await apiGet(f(e)),S="0"===String(e)?"video0":"video1",I=m?.[S]||{};t.checked=function(e){if("boolean"==typeof e)return e;const t=String(e??"").trim().toLowerCase();return"true"===t||"1"===t||"yes"===t}(I.enabled??p.enabled),y(n,I.codec??p.codec),y(o,I.size??v[String(e)]?.[0]??""),y(i,String(I.fps??p.fps)),y(r,I.rcMode??p.rcMode),y(d,I.profile??p.profile),a.value=String(I.bitrate??p.bitrate),c.value=String(I.gopSize??p.gopSize),l.value=String(I.crop??p.crop),"0"===String(e)&&(y(u,I.gopMode??p.gopMode),g.value=String(I.sliceUnits??p.sliceUnits))}catch(m){console.error("[video] loadChannel failed:",m),toast?.error?.("Failed to load video settings")}}async function E(e){if(!function(e){const t=Number(i.value);if(!Number.isInteger(t)||t<1||t>25)return toast?.warning?.("FPS must be between 1 and 25"),!1;const n=Number(a.value);if(!Number.isInteger(n)||n<128||n>1e4)return toast?.warning?.("Bitrate (Kbps) must be between 128 and 10000"),!1;const r=Number(c.value);if(!Number.isInteger(r)||r<1||r>200)return toast?.warning?.("GOP size must be between 1 and 200"),!1;if("0"===String(e)){const e=Number(g.value||0);if(!Number.isInteger(e)||e<0||e>32)return toast?.warning?.("Slice Units must be between 0 and 32"),!1}const d=o.value;return!!v[String(e)]?.includes(d)||(toast?.warning?.("Invalid resolution for the selected stream"),!1)}(e))return;const s={enabled:t.checked,codec:n.value,fps:Number(i.value),bitrate:Number(a.value),rcMode:r.value,profile:d.value,gopSize:Number(c.value),crop:String(l.value||""),size:o.value};"0"===String(e)&&(s.gopMode=u.value,s.sliceUnits=Number(g.value||0)),S(!0);try{await apiPost(f(e),s),await apiPost(API_ENDPOINTS.appConfigApply,{}),toast?.success?.("Video settings saved & applied"),await I(e)}catch(m){console.error("[video] save/apply failed:",m),toast?.error?.("Saving or applying video settings failed")}finally{S(!1)}}e.addEventListener("change",(()=>{I(e.value)})),m.addEventListener("click",(()=>{E(e.value)})),e.value="0",I("0")}));