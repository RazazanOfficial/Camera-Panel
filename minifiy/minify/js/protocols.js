"use strict";document.addEventListener("DOMContentLoaded",(()=>{if(!document.querySelector('[data-tab-content="protocols"]'))return;const e=document.getElementById("protocolType"),t=document.getElementById("rtspSection"),n=document.getElementById("rtspEnabled"),o=document.getElementById("rtspPort"),r=document.getElementById("hlsSection"),a=document.getElementById("hlsEnabled"),c=document.getElementById("jpegSection"),s=document.getElementById("jpegEnabled"),l=document.getElementById("jpegQfactor"),i=document.getElementById("jpegFps"),d=document.getElementById("jpegRtsp"),u=document.getElementById("btnProtocolSave");function p(e){const t=API_ENDPOINTS.video,n=t.includes("?")?"&":"?";return`${t}${n}protocol=${encodeURIComponent(e)}`}function g(e,t){e.style.display=t?"":"none"}function m(e){u.disabled=e,u.classList.toggle("disabled",e),u.style.opacity=e?.75:1}function f(e){if("boolean"==typeof e)return e;const t=String(e??"").trim().toLowerCase();return"true"===t||"1"===t||"yes"===t}function y(e){g(t,"rtsp"===e),g(r,"hls"===e),g(c,"jpeg"===e)}async function b(){try{const e=await apiGet(p("rtsp")),t=e?.rtsp||{};n.checked=f(t.enabled),o.value=null!=t.port?String(t.port):""}catch(e){console.error("[protocols] load rtsp failed:",e),toast?.error?.("Failed to load RTSP settings")}}async function h(e){return"rtsp"===e?b():"hls"===e?async function(){try{const e=await apiGet(p("hls")),t=e?.hls||{};a.checked=f(t.enabled)}catch(e){console.error("[protocols] load hls failed:",e),toast?.error?.("Failed to load HLS settings")}}():"jpeg"===e?async function(){try{const e=await apiGet(p("jpeg")),t=e?.jpeg||{};s.checked=f(t.enabled),null!=t.qfactor&&(l.value=String(t.qfactor)),null!=t.fps&&(i.value=String(t.fps)),d.checked=f(t.rtsp)}catch(e){console.error("[protocols] load jpeg failed:",e),toast?.error?.("Failed to load JPEG settings")}}():void 0}function v(e){if("rtsp"===e&&n.checked&&!function(e){const t=Number(e);return Number.isInteger(t)&&t>=1&&t<=65536}(o.value))return toast?.warning?.("Invalid RTSP port (1–65536)"),!1;if("jpeg"===e&&s.checked){const e=Number(l.value||0),t=Number(i.value||0);if(!Number.isInteger(e)||e<1||e>100)return toast?.warning?.("JPEG QFactor must be 1–100"),!1;if(!Number.isInteger(t)||t<1||t>20)return toast?.warning?.("JPEG FPS must be 1–20"),!1}return!0}e.addEventListener("change",(async()=>{const t=e.value;y(t),await h(t)})),u.addEventListener("click",(async()=>{const t=e.value;if(!v(t))return;const r=p(t),c=function(e){return"rtsp"===e?{enabled:n.checked,port:Number(o.value||554)}:"hls"===e?{enabled:a.checked}:{enabled:s.checked,qfactor:Number(l.value||50),fps:Number(i.value||5),rtsp:d.checked}}(t);m(!0);try{await apiPost(r,c),await apiPost(API_ENDPOINTS.appConfigApply,{}),toast?.success?.(`${t.toUpperCase()} saved & applied`),await h(t)}catch(u){console.error("[protocols] save/apply failed:",u),toast?.error?.("Saving or applying protocol settings failed")}finally{m(!1)}})),async function(){!function(){const e=Array.from({length:20},((e,t)=>t+1));i.innerHTML=e.map((e=>`<option value="${e}">${e}</option>`)).join("")}(),e.value="rtsp",y("rtsp"),await b()}()}));