"use strict";document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector('[data-tab-content="userManagement"]');if(!e)return;const t=e.querySelector("#userTbody"),n=e.querySelector("#btnUserAdd");function r(e){const t=String(e??"").trim().toLowerCase();if("0"===t||"shahaab"===t||"root"===t||"super"===t||"superuser"===t)return"0";if("1"===t||"admin"===t||"administrator"===t||"adminstrator"===t)return"1";if("2"===t||"user"===t||"operator"===t)return"2";const n=Number(e);return Number.isNaN(n)||0!==n&&1!==n&&2!==n?"2":String(n)}function a(){t.innerHTML='\n      <tr>\n        <td class="border-2 text-center" colspan="4">No data</td>\n      </tr>\n    '}function s(e){if(!Array.isArray(e)||0===e.length)return void a();const n=e.map(((e,t)=>{const n=t+1;return`\n          <tr data-line="${n}">\n            <th scope="row" class="border-2">${n}</th>\n            <td class="border-2">${e?.username??""}</td>\n            <td class="border-2">${function(e){const t=String(e??"").trim().toLowerCase();if("0"===t||"shahaab"===t||"root"===t||"super"===t||"superuser"===t)return"Shahaab";if("1"===t||"admin"===t||"administrator"===t||"adminstrator"===t)return"Administrator";if("2"===t||"user"===t||"operator"===t)return"User";const n=Number(e);if(!Number.isNaN(n)){if(0===n)return"Shahaab";if(1===n)return"Administrator";if(2===n)return"User"}return"User"}(e?.level)}</td>\n            <td class="border-2">\n              <button\n                type="button"\n                class="btn btn-link p-0 me-3"\n                data-action="modify"\n                title="Modify"\n                aria-label="Modify"\n              >Modify</button>\n              <button\n                type="button"\n                class="btn btn-link text-danger p-0"\n                data-action="delete"\n                title="Delete"\n                aria-label="Delete"\n              >Delete</button>\n            </td>\n          </tr>\n        `})).join("");t.innerHTML=n}async function o(){try{const e=await apiGet(API_ENDPOINTS.userList);s(e?.users||[])}catch(e){console.error("[userMng] GET list failed:",e),a(),window.toast?.error?.("Failed to load users")}}n&&n.addEventListener("click",(()=>{window.UserManegmentModal&&UserManegmentModal.openAdd((async({username:e,password:t,level:n})=>{try{await async function({username:e,password:t,level:n}){const a={username:e,password:t,level:r(n)};return apiPost(API_ENDPOINTS.userList,a)}({username:e,password:t,level:n}),window.toast?.success?.("User added"),await o()}catch(a){console.error("[userMng] add failed:",a),window.toast?.error?.("Add failed")}}))})),t.addEventListener("click",(e=>{const t=e.target.closest("button[data-action]");if(!t)return;const n=t.closest("tr"),a=Number(n?.dataset?.line),s=n?.children?.[1]?.textContent?.trim()||"",i=n?.children?.[2]?.textContent?.trim()||"User",d="Shahaab"===i?"0":"Administrator"===i?"1":"2";if("modify"===t.dataset.action){if(!window.UserManegmentModal)return;UserManegmentModal.openEdit({username:s,level:d,number_line:a},(async({number_line:e,username:t,password:n,level:a})=>{try{await async function({number_line:e,username:t,password:n,level:a}){const s={number_line:e,username:t,password:n,level:r(a)};return apiPost(API_ENDPOINTS.userModify,s)}({number_line:e,username:t,password:n,level:a}),window.toast?.success?.("User updated"),await o()}catch(s){console.error("[userMng] modify failed:",s),window.toast?.error?.("Update failed")}}))}if("delete"===t.dataset.action){if(!window.UserManegmentModal)return;UserManegmentModal.openDelete({number_line:a,username:s},(async({number_line:e})=>{try{await async function({number_line:e}){const t={number_line:e};return apiPost(API_ENDPOINTS.userDelete,t)}({number_line:e}),window.toast?.success?.("User deleted"),await o()}catch(t){console.error("[userMng] delete failed:",t),window.toast?.error?.("Delete failed")}}))}})),o()}));