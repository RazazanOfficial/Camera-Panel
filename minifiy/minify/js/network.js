"use strict";
document.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("ipv4Dhcp"),e=document.getElementById("ipv4Address"),n=document.getElementById("ipv4SubnetMask"),a=document.getElementById("ipv4DefaultGetWay"),r=document.getElementById("preferredDnsServer"),o=document.getElementById("macAddress"),i=document.getElementById("mtu"),s=document.getElementById("btnNetworkSave");function d(t){e&&(e.disabled=t,n.disabled=t,a.disabled=t,r.disabled=t)}function l(t){return!!String(t||"").trim().match(/^(\d{1,3}\.){3}\d{1,3}$/)&&t.split(".").map(Number).every((t=>t>=0&&t<=255))}function c(){if(!t||t.checked)return!0;const o=e.value.trim(),i=n.value.trim(),s=a.value.trim(),d=r.value.trim();return l(o)?l(i)?s&&!l(s)?(toast?.warning?.("Invalid IPv4 Gateway"),!1):!(d&&!l(d))||(toast?.warning?.("Invalid IPv4 DNS"),!1):(toast?.warning?.("Invalid IPv4 Subnet Mask"),!1):(toast?.warning?.("Invalid IPv4 Address"),!1)}function u(t,e){t&&(t.disabled=e,t.classList.toggle("disabled",e),t.style.opacity=e?.75:1)}async function p(){if(e)try{const o=await apiGet(API_ENDPOINTS.netIPv4),i=function(t){if("boolean"==typeof t)return t;const e=String(t??"").trim().toLowerCase();return"true"===e||"1"===e||"yes"===e}(o?.dhcp);t&&(t.checked=i),e.value=o?.ipv4_address||"",n.value=o?.ipv4_netmask||"",a.value=o?.ipv4_gateway||"",r.value=o?.ipv4_dns||"",d(i)}catch(o){console.error("[network] loadIPv4 failed:",o),toast?.error?.("Failed to load IPv4 settings")}}async function v(){if(o)try{const t=await apiGet(API_ENDPOINTS.netMac),e=t?.mac||t?.mac_address||t?.macAddr||"";o.value=e}catch(t){console.error("[network] loadMac failed:",t),toast?.error?.("Failed to load MAC address")}}async function m(){if(i)try{const t=await apiGet(API_ENDPOINTS.netMtu),e=t?.mtu||t?.MTU||t?.value||"";e&&(i.value=String(e))}catch(t){console.error("[network] loadMtu failed:",t),toast?.error?.("Failed to load MTU")}}t?.addEventListener("change",(()=>{d(t.checked)})),s?.addEventListener("click",(async()=>{if(!function(){if(!i)return!0;const t=Number(i.value);return Number.isFinite(t)?!(t<500||t>1e4)||(toast?.warning?.("MTU out of range (500-10000)"),!1):(toast?.warning?.("MTU must be a number"),!1)}())return;if(!c())return;const o=t?.checked??!1?{dhcp:!0}:{ipv4_address:e.value.trim(),ipv4_netmask:n.value.trim(),ipv4_gateway:a.value.trim(),ipv4_dns:r.value.trim(),dhcp:!1},d=i?{mtu:String(Number(i.value))}:null;u(s,!0);try{const t=[apiPost(API_ENDPOINTS.netIPv4,o)];d&&t.push(apiPost(API_ENDPOINTS.netMtu,d)),await Promise.all(t),toast?.success?.("Network settings saved"),await Promise.all([p(),m()])}catch(l){console.error("[network] save IPv4/MTU failed:",l),toast?.error?.("Saving network settings failed")}finally{u(s,!1)}}));const g=document.getElementById("httpPort"),I=document.getElementById("rtspPort"),P=document.getElementById("httpsPort"),f=document.getElementById("btnPortSave");function y(t){const e=Number(t);return Number.isInteger(e)&&e>=1&&e<=65535}async function w(){if(g&&I&&P)try{const t=await apiGet(API_ENDPOINTS.netPorts);t?.http_port&&(g.value=String(t.http_port)),t?.rtsp_port&&(I.value=String(t.rtsp_port)),t?.https_port&&(P.value=String(t.https_port))}catch(t){console.error("[network] loadPorts failed:",t),toast?.error?.("Failed to load port settings")}}f?.addEventListener("click",(async()=>{if(!function(){if(!g||!I||!P)return!0;const t=Number(g.value),e=Number(I.value),n=Number(P.value);return y(t)?y(e)?!!y(n)||(toast?.warning?.("Invalid HTTPS port (1-65535)"),!1):(toast?.warning?.("Invalid RTSP port (1-65535)"),!1):(toast?.warning?.("Invalid HTTP port (1-65535)"),!1)}())return;const t={http_port:String(Number(g.value)),https_port:String(Number(P.value)),rtsp_port:String(Number(I.value))};u(f,!0);try{await apiPost(API_ENDPOINTS.netPorts,t),await apiPost(API_ENDPOINTS.appConfigApply,{}),toast?.success?.("Ports saved & applied"),toast?.info?.("If you changed HTTP/HTTPS ports, reconnect using the new port."),await w()}catch(e){console.error("[network] save/apply Ports failed:",e),toast?.error?.("Saving or applying ports failed")}finally{u(f,!1)}})),async function(){await Promise.all([p(),v(),m(),w()])}()}));