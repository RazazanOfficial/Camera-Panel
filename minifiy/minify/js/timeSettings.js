const timezones=[{value:"Asia/Tehran",text:"Asia/Tehran  (UTC+03:30)"},{value:"Asia/Dubai",text:"Asia/Dubai  (UTC+04:00)"},{value:"Asia/Riyadh",text:"Asia/Riyadh  (UTC+03:00)"},{value:"Asia/Jerusalem",text:"Asia/Jerusalem  (UTC+02:00)"},{value:"Asia/Karachi",text:"Asia/Karachi  (UTC+05:00)"},{value:"Asia/Kolkata",text:"Asia/Kolkata  (UTC+05:30)"},{value:"Asia/Dhaka",text:"Asia/Dhaka  (UTC+06:00)"},{value:"Asia/Bangkok",text:"Asia/Bangkok  (UTC+07:00)"},{value:"Asia/Singapore",text:"Asia/Singapore  (UTC+08:00)"},{value:"Asia/Hong_Kong",text:"Asia/Hong_Kong  (UTC+08:00)"},{value:"Asia/Shanghai",text:"Asia/Shanghai  (UTC+08:00)"},{value:"Asia/Tokyo",text:"Asia/Tokyo  (UTC+09:00)"},{value:"Asia/Seoul",text:"Asia/Seoul  (UTC+09:00)"},{value:"Asia/Jakarta",text:"Asia/Jakarta  (UTC+07:00)"},{value:"Australia/Sydney",text:"Australia/Sydney  (UTC+10:00)"},{value:"Pacific/Auckland",text:"Pacific/Auckland  (UTC+12:00)"},{value:"America/St_Johns",text:"America/St_Johns  (UTC-03:30)"},{value:"America/Halifax",text:"America/Halifax  (UTC-04:00)"},{value:"America/New_York",text:"America/New_York  (UTC-05:00)"},{value:"America/Chicago",text:"America/Chicago  (UTC-06:00)"},{value:"America/Denver",text:"America/Denver  (UTC-07:00)"},{value:"America/Los_Angeles",text:"America/Los_Angeles  (UTC-08:00)"},{value:"America/Phoenix",text:"America/Phoenix  (UTC-07:00)"},{value:"America/Anchorage",text:"America/Anchorage  (UTC-09:00)"},{value:"Pacific/Honolulu",text:"Pacific/Honolulu  (UTC-10:00)"},{value:"America/Mexico_City",text:"America/Mexico_City  (UTC-06:00)"},{value:"America/Bogota",text:"America/Bogota  (UTC-05:00)"},{value:"America/Lima",text:"America/Lima  (UTC-05:00)"},{value:"America/Santiago",text:"America/Santiago  (UTC-03:00)"},{value:"America/Sao_Paulo",text:"America/Sao_Paulo  (UTC-03:00)"},{value:"America/Argentina/Buenos_Aires",text:"America/Argentina/Buenos_Aires  (UTC-03:00)"},{value:"Africa/Cairo",text:"Africa/Cairo  (UTC+02:00)"},{value:"Africa/Nairobi",text:"Africa/Nairobi  (UTC+03:00)"},{value:"Africa/Johannesburg",text:"Africa/Johannesburg  (UTC+02:00)"},{value:"Africa/Lagos",text:"Africa/Lagos  (UTC+01:00)"},{value:"Africa/Casablanca",text:"Africa/Casablanca  (UTC+00:00)"},{value:"Asia/Kuala_Lumpur",text:"Asia/Kuala_Lumpur  (UTC+08:00)"},{value:"Asia/Manila",text:"Asia/Manila  (UTC+08:00)"},{value:"America/Toronto",text:"America/Toronto  (UTC-05:00)"},{value:"America/Vancouver",text:"America/Vancouver  (UTC-08:00)"},{value:"Asia/Tbilisi",text:"Asia/Tbilisi  (UTC+04:00)"},{value:"Asia/Yerevan",text:"Asia/Yerevan  (UTC+04:00)"},{value:"Asia/Baku",text:"Asia/Baku  (UTC+04:00)"},{value:"Asia/Ashgabat",text:"Asia/Ashgabat  (UTC+05:00)"},{value:"Asia/Dushanbe",text:"Asia/Dushanbe  (UTC+05:00)"},{value:"Asia/Kabul",text:"Asia/Kabul  (UTC+04:30)"},{value:"Asia/Almaty",text:"Asia/Almaty  (UTC+06:00)"},{value:"Asia/Tashkent",text:"Asia/Tashkent  (UTC+05:00)"},{value:"Asia/Baghdad",text:"Asia/Baghdad  (UTC+03:00)"},{value:"Asia/Kuwait",text:"Asia/Kuwait  (UTC+03:00)"},{value:"Asia/Doha",text:"Asia/Doha  (UTC+03:00)"},{value:"Asia/Manama",text:"Asia/Manama  (UTC+03:00)"},{value:"Asia/Muscat",text:"Asia/Muscat  (UTC+04:00)"},{value:"Asia/Aden",text:"Asia/Aden  (UTC+03:00)"},{value:"Asia/Beirut",text:"Asia/Beirut  (UTC+02:00)"},{value:"Asia/Damascus",text:"Asia/Damascus  (UTC+03:00)"},{value:"Asia/Amman",text:"Asia/Amman  (UTC+02:00)"},{value:"Asia/Sanaa",text:"Asia/Sanaa  (UTC+03:00)"},{value:"Asia/Pyongyang",text:"Asia/Pyongyang  (UTC+09:00)"}];function loadTimezones(){const e=document.getElementById("timeZone");e&&(e.innerHTML="",timezones.forEach((t=>{const a=document.createElement("option");a.value=t.value,a.textContent=t.text,e.appendChild(a)})))}function normalizeTimezoneResponse(e){if(!e)return"";if("object"==typeof e){const t=e.timezone||e.tz||e.zone||e.value||e?.data?.timezone||e?.payload?.timezone;if("string"==typeof t)return t.trim();const a=JSON.stringify(e).match(/[A-Za-z_]+\/[A-Za-z_\/]+/);return a?a[0]:""}const t=String(e).trim();if(t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]"))try{return normalizeTimezoneResponse(JSON.parse(t))}catch(n){}const a=(t.split(/\r?\n/).find((e=>e.includes("/")))||t).trim(),i=a.match(/[A-Za-z_]+\/[A-Za-z_\/]+/);return i?i[0]:a.split(/\s+/)[0]}async function getTimezoneSettings(){try{const e=normalizeTimezoneResponse(await apiGet(API_ENDPOINTS.timezone)),t=document.getElementById("timeZone");if(t){const a=timezones.some((t=>t.value===e));t.value=a?e:"Asia/Tehran"}}catch(e){toast.error("Failed to get timezone settings"),console.error("Failed to get timezone settings:",e)}}async function saveTimezoneSettings(){const e=document.getElementById("timeZone");if(!e)return;const t=e.value||"";return apiPost(API_ENDPOINTS.timezone,{timezone:t})}function normalizeNtpResponse(e){if(!e)return"";if("object"==typeof e){const t=e.ntp_server||e.server||e.ntp||e.address||e.value;if("string"==typeof t)return t.trim();const a=Object.values(e).find((e=>"string"==typeof e));return a?a.trim():""}const t=String(e).trim(),a=(t.split(/\r?\n/).find((e=>/ntp|server/i.test(e)))||t).trim(),i=a.match(/((\d{1,3}\.){3}\d{1,3})|([a-z0-9-]+\.)+[a-z]{2,}/i);return i?i[0]:a.split(/\s+/).find(Boolean)||""}async function getNtpSettings(){try{const e=normalizeNtpResponse(await apiGet(API_ENDPOINTS.ntp)),t=document.getElementById("serverAddress");t&&e&&(t.value=e)}catch(e){toast.error("Failed to get NTP settings"),console.error("Failed to get NTP settings:",e)}}async function saveNtpSettings(){const e=document.getElementById("serverAddress"),t=(e?.value||"").trim();if(t)return apiPost(API_ENDPOINTS.ntp,{ntp_server:t})}const DEVICE_TIME_POLL_MS=1e3;let deviceTimeTimer=null,simulatedDeviceDate=null;function pad2(e){return e<10?"0"+e:""+e}function formatYMDHMS(e){return`${e.getFullYear()}-${pad2(e.getMonth()+1)}-${pad2(e.getDate())} ${pad2(e.getHours())}:${pad2(e.getMinutes())}:${pad2(e.getSeconds())}`}function parseYMDHMS(e){const t=String(e).match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})/);if(!t)return null;const a=+t[1],i=+t[2],n=+t[3],o=+t[4],s=+t[5],r=+t[6];return new Date(a,i-1,n,o,s,r)}function updateDeviceTimeInputFromSim(){const e=document.getElementById("diviceTime");e&&simulatedDeviceDate&&(e.value=formatYMDHMS(simulatedDeviceDate))}function normalizeLocalTimeString(e){if(!e)return"";if("object"==typeof e){const t=e.local_time||e.localTime||e.time||e.value;if("string"==typeof t)return t.trim();const a=JSON.stringify(e).match(/\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/);return a?a[0]:""}const t=String(e).trim();if(t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]"))try{return normalizeLocalTimeString(JSON.parse(t))}catch(i){}const a=t.match(/\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/);return a?a[0]:t}async function refreshDeviceTimeOnce(){try{const e=parseYMDHMS(normalizeLocalTimeString(await apiGet(API_ENDPOINTS.localTime)));e&&(simulatedDeviceDate=e,updateDeviceTimeInputFromSim())}catch(e){toast.error("Failed to seed device time."),console.error("Failed to seed device time:",e)}}function tickDeviceTime(){simulatedDeviceDate&&(simulatedDeviceDate=new Date(simulatedDeviceDate.getTime()+1e3),updateDeviceTimeInputFromSim())}function stopDeviceTimePolling(){deviceTimeTimer&&(clearInterval(deviceTimeTimer),deviceTimeTimer=null)}async function startDeviceTimePolling(){stopDeviceTimePolling(),await refreshDeviceTimeOnce(),deviceTimeTimer=setInterval(tickDeviceTime,1e3)}function setManualInputsEnabled(e){const t=document.getElementById("setDate"),a=document.getElementById("setTime");t&&(t.disabled=!e),a&&(a.disabled=!e)}function buildLocalTimePayload(){const e=document.getElementById("setDate"),t=document.getElementById("setTime"),a=(e?.value||"").trim();let i=(t?.value||"").trim();return a&&i||toast.error("Please enter the full date and time."),/^\d{2}:\d{2}:\d{2}$/.test(i)||(/^\d{2}:\d{2}$/.test(i)?i=`${i}:00`:toast.error("The time is invalid. Correct example: 10:35:51")),`${a} ${i}`}async function saveManualTimeIfEnabled(){const e=document.getElementById("manualTimeToggle");if(!e||!e.checked)return;const t=buildLocalTimePayload();return apiPost(API_ENDPOINTS.localTime,{local_time:t})}document.addEventListener("DOMContentLoaded",(function(){loadTimezones(),getTimezoneSettings(),getNtpSettings(),startDeviceTimePolling();const e=document.getElementById("saveNtp");e&&e.addEventListener("click",(async()=>{try{await saveNtpSettings(),toast.success("NTP saved.")}catch(e){toast.error("Saving NTP failed."),console.error("Failed to save NTP:",e)}}));const t=document.getElementById("saveManualTime");t&&t.addEventListener("click",(async()=>{try{await saveManualTimeIfEnabled(),toast.success("Manual Time saved."),setTimeout((()=>window.location.reload()),2e3)}catch(e){console.error("Failed to save manual time:",e),toast.error("Saving manual time failed.")}}));const a=document.getElementById("manualTimeToggle");a&&(a.addEventListener("change",(e=>{setManualInputsEnabled(e.target.checked)})),setManualInputsEnabled(!1));const i=document.getElementById("timeZone");if(!i)return;let n=i.value;async function o(e){if("function"!=typeof apiPost||!API_ENDPOINTS?.timezone){if("function"==typeof saveTimezoneSettings)return i.value=e,void await Auth.clearTokenAfter(saveTimezoneSettings(),{redirectToLogin:!0});throw toast.error("No timezone POST method available."),new Error("No timezone POST method available")}await Auth.clearTokenAfter(apiPost(API_ENDPOINTS.timezone,{timezone:e}),{redirectToLogin:!1})}i.addEventListener("change",(()=>{const e=i.value||"Asia/Tehran";if(!window.RebootModal?.confirmAndReboot)return window.confirm("This change will reboot the camera. Continue?")?(i.disabled=!0,void o(e).then((()=>{n=e,setTimeout((()=>window.location.reload()),300)}))["catch"]((e=>{console.error(e),toast.error("Saving timezone failed."),i.value=n,i.disabled=!1}))):void(i.value=n);RebootModal.confirmAndReboot({title:"Change Timezone",message:"This change will <b>reboot the camera</b>. Are you sure?",seconds:15,lockTitle:"Rebootingâ€¦",lockMessage:"Camera is Rebooting, Please wait!",onConfirm:async()=>{i.disabled=!0,await o(e),n=e},onCancel:()=>{i.value=n}})["catch"]((e=>{console.error("Saving timezone failed:",e),toast.error("Saving timezone failed."),i.value=n,i.disabled=!1}))}))}));