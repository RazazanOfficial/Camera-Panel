"use strict";document.addEventListener("DOMContentLoaded",(()=>{const e={enabled:document.getElementById("osdEnabled"),baseText:document.getElementById("osdBaseText"),tDay:document.getElementById("osdTokenDay"),tMonth:document.getElementById("osdTokenMonth"),tYear:document.getElementById("osdTokenYear"),tHour:document.getElementById("osdTokenHour"),tMin:document.getElementById("osdTokenMinute"),tSec:document.getElementById("osdTokenSecond"),preview:document.getElementById("osdPreviewTemplate"),size:document.getElementById("osdSize"),posX:document.getElementById("osdPosX"),posY:document.getElementById("osdPosY"),btnApply:document.getElementById("btnOsdApply")};function t(e,t,n){const o=Number(e);return Number.isFinite(o)?Math.max(t,Math.min(n,o)):t}function n(t){[e.baseText,e.tDay,e.tMonth,e.tYear,e.tHour,e.tMin,e.tSec,e.size,e.posX,e.posY].forEach((e=>{e&&(e.disabled=t)}))}function o(t){e.btnApply.disabled=t,e.btnApply.classList.toggle("disabled",t),e.btnApply.style.opacity=t?.75:1}function s(){const t=String(e.baseText?.value??"").trim(),{date:n,time:o}=function(){const t=[];e.tDay?.checked&&t.push("%d"),e.tMonth?.checked&&t.push("%m"),e.tYear?.checked&&t.push("%Y");const n=[];return e.tHour?.checked&&n.push("%H"),e.tMin?.checked&&n.push("%M"),e.tSec?.checked&&n.push("%S"),{date:t,time:n}}(),s=[];return t&&s.push(t),n.length&&s.push(n.join(".")),o.length&&s.push(o.join(":")),s.join(" ").trim()}function a(){e.preview&&(e.preview.value=s())}async function d(){try{const o=await apiGet(API_ENDPOINTS.osd);e.enabled&&(e.enabled.checked=function(e){if("boolean"==typeof e)return e;const t=String(e??"").trim().toLowerCase();return"true"===t||"1"===t||"yes"===t}(o?.enabled)),function(t){const n=t.search(/%(d|m|Y|H|M|S)/g);let o=t,s="";n>=0&&(o=t.slice(0,n),s=t.slice(n));const d=e=>s.includes(e);e.baseText&&(e.baseText.value=o),e.tDay&&(e.tDay.checked=d("%d")),e.tMonth&&(e.tMonth.checked=d("%m")),e.tYear&&(e.tYear.checked=d("%Y")),e.tHour&&(e.tHour.checked=d("%H")),e.tMin&&(e.tMin.checked=d("%M")),e.tSec&&(e.tSec.checked=d("%S")),a()}(String(o?.template??"")),e.size&&(e.size.value=String(t(o?.size??20,1,60))),e.posX&&(e.posX.value=String(t(o?.posX??10,1,65536))),e.posY&&(e.posY.value=String(t(o?.posY??10,1,65536))),n(!e.enabled?.checked)}catch(o){console.error("[osd] load failed:",o),toast?.error?.("Failed to load OSD settings")}}e.btnApply&&([e.baseText,e.tDay,e.tMonth,e.tYear,e.tHour,e.tMin,e.tSec].filter(Boolean).forEach((e=>e.addEventListener("input",a))),e.enabled?.addEventListener("change",(()=>{n(!e.enabled.checked)})),e.btnApply.addEventListener("click",(async function(){if(function(){const t=Number(e.size?.value),n=Number(e.posX?.value),o=Number(e.posY?.value);return!Number.isInteger(t)||t<1||t>60?(toast?.warning?.("Size must be 1–60"),!1):!Number.isInteger(n)||n<1||n>65536?(toast?.warning?.("Position X must be 1–65536"),!1):!Number.isInteger(o)||o<1||o>65536?(toast?.warning?.("Position Y must be 1–65536"),!1):!(s().length>200&&(toast?.warning?.("Template is too long (max 200)"),1))}()){o(!0);try{await apiPost(API_ENDPOINTS.osd,{enabled:!!e.enabled?.checked,template:s(),size:Number(e.size?.value),posX:Number(e.posX?.value),posY:Number(e.posY?.value)}),await apiPost(API_ENDPOINTS.appConfigApply,{}),"function"==typeof refreshMjpegStream&&refreshMjpegStream(),toast?.success?.("OSD settings saved & applied"),await d()}catch(t){console.error("[osd] save/apply failed:",t),toast?.error?.("Saving or applying OSD settings failed")}finally{o(!1)}}})),a(),d())}));